# vim ft=yaml
# Multiple lines can be made a single "virtual line" because of the way that
# Travis munges each line before executing it to print out the exit status.
# It's okay for it to be on multiple physical lines, so long as you remember:
# - There can't be any leading "-"s - All newlines will be removed, so use
# ";"s
sudo: false  # To use travis container infrastructure

dist: xenial

language: cpp

os:
  - linux
  - osx

compiler:
  - clang
  - gcc

matrix:
  fast_finish: true
  allow_failures:
    - os: osx
  exclude:
    - os: osx # This is identical (apparently) to os: osx and compiler: clang
      compiler: gcc

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - libeigen3-dev
      - libsuitesparse-dev
      - libboost-dev
      - libsundials-serial-dev
      - octave
      - liboctave-dev
      - g++-6
  homebrew:
    packages:
      - eigen
      - octave
      - boost
      - suitesparse
      - sundials

# Set global environment variables
env:
  global:
    - USE_OCTAVE=true

#TODO: Use packaged sundials version
install:
  # Set necessary environment variables (platform/dep version dependent)
  # Note: multi-line YAML syntax used here.
  - |
    if [[ "${TRAVIS_OS_NAME}" == "osx" ]]; then
      export SUITESPARSE_ROOT=/usr/local/Cellar/suite-sparse/5.3.0/include/;
      export SUITESPARSE_LDIR=/usr/local/Cellar/suite-sparse/5.3.0/lib/;
      export SUNDIALS_ROOT=/usr/local/Cellar/sundials/4.1.0/;
      export EIGEN_ROOT=/usr/local/include/eigen3/;
      export OCTAVE_INC="-I/usr/local/include/octave-4.4.1/octave/";
      export OCTAVE_LDIR=/usr/local/lib/octave/4.4.1/;
    elif [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
      export SUITESPARSE_ROOT=/usr/include/suitesparse;
      export SUITESPARSE_LDIR=/usr/lib/x86_64-linux-gnu;
      export EIGEN_ROOT=/usr/include/eigen3;
      export OCTAVE_ROOT=/usr/include/octave-4.0.0/octave;
      export OCTAVE_INC="-I${OCTAVE_ROOT}";
      export OCTAVE_LDIR=/usr/local/lib/octave;
      # Override default compiler with newer one, only on GCC, which
      # appears to be the only way to get a new enough stdlib.
      if [[ ${TRAVIS_COMPILER} == "gcc" ]]; then
        export CC=gcc-6;
        export CC_FOR_BUILD=${CC};
        export CXX=g++-6;
        export CXX_FOR_BUILD=${CXX};
      fi
    fi

script:
  - cd ${TRAVIS_BUILD_DIR}
  - make pde1d.mex
